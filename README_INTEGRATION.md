# –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (Prospekt.Calc)

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–ª–∏–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ postMessage API.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—è–º–∏**: –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏
- **–ì—Ä—É–ø–ø—ã —Å–∫—Ä–µ–ø–ª–µ–Ω–∏—è**: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –≤ –≥—Ä—É–ø–ø—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –¥–æ 3 —É—Ä–æ–≤–Ω–µ–π
- **–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã –Ω–∞ –¥–µ—Ç–∞–ª—å —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- **Drag & Drop**: –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
- **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ —Å–µ–ª–µ–∫—Ç—ã**: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
- **PostMessage API**: –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –æ–∫–Ω–æ–º (1–°-–ë–∏—Ç—Ä–∏–∫—Å)
- **–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
npm run dev

# –°–±–æ—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
npm run build
```

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ postMessage

–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –æ–∫–Ω–æ–º —á–µ—Ä–µ–∑ postMessage API.

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –û—Ç–∫—Ä–æ–π—Ç–µ `test-integration.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. Iframe –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å localhost:5173
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ API

**–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä:**
```javascript
iframe.contentWindow.postMessage({
    type: 'STATE_RESPONSE',
    data: {
        selectedVariantIds: [525, 526],
        testVariantId: 525,
        details: [...],
        bindings: [...]
    }
}, '*');
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞:**
```javascript
window.addEventListener('message', (event) => {
    const payload = event.data;
    
    if (payload.type === 'STATE_UPDATE') {
        console.log('State changed:', payload.data);
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
    }
    
    if (payload.type === 'CALCULATION_COMPLETE') {
        console.log('Calculation result:', payload.data.result);
        // –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã
    }
});
```

### –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º–æ—Ç—Ä–∏—Ç–µ [POSTMESSAGE_API.md](./POSTMESSAGE_API.md) –¥–ª—è:
- –î–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–∏–º–µ—Ä–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å PHP/JavaScript
- –ü—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è 1–°-–ë–∏—Ç—Ä–∏–∫—Å
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä:
```bash
npm run dev
```

2. –û—Ç–∫—Ä–æ–π—Ç–µ `test-integration.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ

3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è:
   - –ó–∞–ø—Ä–æ—Å–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –ó–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–±—ã—Ç–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 1–°-–ë–∏—Ç—Ä–∏–∫—Å

1. –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å iframe –≤ –ë–∏—Ç—Ä–∏–∫—Å
3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–ø—Ä–∏–º–µ—Ä—ã –≤ POSTMESSAGE_API.md)
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ calculator/        # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ ui/               # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (shadcn)
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ use-mobile.ts
‚îÇ   ‚îî‚îÄ‚îÄ use-postmessage.ts # Hook –¥–ª—è postMessage
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ postmessage-bridge.ts  # –Ø–¥—Ä–æ postMessage API
‚îÇ   ‚îú‚îÄ‚îÄ types.ts          # TypeScript —Ç–∏–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ mock-data.ts      # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ App.tsx               # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îî‚îÄ‚îÄ index.css             # –°—Ç–∏–ª–∏
```

## üé® –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **React 19** - UI —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **TypeScript** - –¢–∏–ø–∏–∑–∞—Ü–∏—è
- **Tailwind CSS** - –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
- **shadcn/ui** - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **Vite** - –°–±–æ—Ä—â–∏–∫
- **Phosphor Icons** - –ò–∫–æ–Ω–∫–∏
- **Sonner** - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### PostMessage Origin

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ª—é–±–æ–≥–æ origin (`*`). 

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É origin –≤ `src/lib/postmessage-bridge.ts`:

```typescript
postMessageBridge.setTargetOrigin('https://your-bitrix-domain.com');
```

### LocalStorage

–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `calc_`:
- `calc_header_tabs` - —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —à–∞–ø–∫–µ
- `calc_details` - –¥–µ—Ç–∞–ª–∏
- `calc_bindings` - –≥—Ä—É–ø–ø—ã —Å–∫—Ä–µ–ø–ª–µ–Ω–∏—è
- `calc_info_panel_expanded` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```javascript
// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å
window.addEventListener('message', (event) => {
    if (event.data.type === 'INIT') {
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ë–î
        const savedState = await loadCalculatorState(variantId);
        
        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
        iframe.contentWindow.postMessage({
            type: 'STATE_RESPONSE',
            data: savedState
        }, '*');
    }
});
```

### –ü—Ä–∏–º–µ—Ä 2: –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```javascript
// –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –ë–î
window.addEventListener('message', (event) => {
    if (event.data.type === 'STATE_UPDATE') {
        saveCalculatorState(variantId, event.data.data);
    }
});
```

### –ü—Ä–∏–º–µ—Ä 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á—ë—Ç–∞

```javascript
window.addEventListener('message', (event) => {
    if (event.data.type === 'CALCULATION_COMPLETE') {
        const { cost, details } = event.data.data.result;
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã –≤ –ë–∏—Ç—Ä–∏–∫—Å
        updateProductPrice(variantId, cost);
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        showCalculationResults(cost, details);
    }
});
```

## üêõ –û—Ç–ª–∞–¥–∫–∞

–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è postMessage –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:

```
[PostMessageBridge] Sending: STATE_UPDATE {...}
[PostMessageBridge] Received: STATE_REQUEST undefined
[App] Received message: { type: 'INIT', data: ... }
```

–í–∫–ª—é—á–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - Copyright GitHub, Inc.

---

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–º–æ—Ç—Ä–∏—Ç–µ:
- [POSTMESSAGE_API.md](./POSTMESSAGE_API.md) - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- [PRD.md](./PRD.md) - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É
- `test-integration.html` - –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–æ–≤–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
